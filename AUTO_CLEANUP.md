# è‡ªåŠ¨æ•°æ®åº“æ¸…ç†åŠŸèƒ½ / Automatic Database Cleanup

## ğŸ“‹ æ¦‚è¿° / Overview

ç³»ç»Ÿç°åœ¨ä¼šåœ¨æ¯æ¬¡æ‰¹é‡æ›´æ–°æ•°æ®åº“æ—¶è‡ªåŠ¨è¿è¡Œè½»é‡çº§æ¸…ç†ï¼Œä¿æŒæ•°æ®åº“å¤§å°åœ¨åˆç†èŒƒå›´å†…ã€‚

The system now automatically runs lightweight cleanup after each batch database update to keep the database size manageable.

---

## ğŸ”§ å®ç°æ–¹å¼ / Implementation

### è‡ªåŠ¨æ¸…ç†è§¦å‘æ¡ä»¶

1. **æ‰¹é‡æ›´æ–°æ—¶è‡ªåŠ¨æ¸…ç†**ï¼š
   - å½“ `upsert_many()` å‡½æ•°ä¿å­˜ **10 ä¸ªæˆ–æ›´å¤š** supervisor profiles æ—¶
   - è‡ªåŠ¨åˆ é™¤æ‰€æœ‰ `page_cache` æ¡ç›®
   - é™åˆ¶ç¼“å­˜æœ€å¤§æ¡ç›®æ•°ä¸º 500ï¼ˆå¦‚æœè¶…è¿‡åˆ™åˆ é™¤æœ€æ—§çš„ï¼‰

2. **æ¸…ç†å†…å®¹**ï¼š
   - âœ… åˆ é™¤æ‰€æœ‰ `page_cache` æ¡ç›®ï¼ˆå¯é‡æ–°ç”Ÿæˆï¼‰
   - âœ… é™åˆ¶ç¼“å­˜å¤§å°ï¼ˆæœ€å¤š 500 æ¡ï¼‰
   - âŒ **ä¸è¿è¡Œ VACUUM**ï¼ˆå› ä¸º VACUUM å¾ˆæ…¢ï¼Œä¸é€‚åˆè‡ªåŠ¨è¿è¡Œï¼‰

### ä»£ç ä½ç½®

- **æ¸…ç†å‡½æ•°**ï¼š`app/modules/db_cleanup.py`
  - `auto_cleanup_page_cache()` - è½»é‡çº§é¡µé¢ç¼“å­˜æ¸…ç†
  - `auto_cleanup_evidence_snippets()` - è¯æ®ç‰‡æ®µæ¸…ç†ï¼ˆå¯é€‰ï¼‰

- **è‡ªåŠ¨è°ƒç”¨**ï¼š`app/modules/local_repo.py`
  - `upsert_many()` å‡½æ•°åœ¨æ‰¹é‡æ›´æ–°åè‡ªåŠ¨è°ƒç”¨æ¸…ç†

---

## âš™ï¸ é…ç½® / Configuration

### å½“å‰è®¾ç½®

```python
# åœ¨ upsert_many() ä¸­
if len(profiles) >= 10:  # æ‰¹é‡æ›´æ–°é˜ˆå€¼
    auto_cleanup_page_cache(
        keep_days=0,           # åˆ é™¤æ‰€æœ‰ç¼“å­˜
        max_cache_entries=500   # æœ€å¤šä¿ç•™ 500 æ¡
    )
```

### è°ƒæ•´å‚æ•°

å¦‚æœéœ€è¦è°ƒæ•´æ¸…ç†è¡Œä¸ºï¼Œå¯ä»¥ä¿®æ”¹ `app/modules/local_repo.py` ä¸­çš„å‚æ•°ï¼š

```python
# ä¿®æ”¹æ‰¹é‡æ›´æ–°é˜ˆå€¼ï¼ˆé»˜è®¤ï¼š10ï¼‰
if len(profiles) >= 10:  # æ”¹ä¸ºå…¶ä»–æ•°å­—ï¼Œå¦‚ 5 æˆ– 20

# ä¿®æ”¹ç¼“å­˜ä¿ç•™æ•°é‡ï¼ˆé»˜è®¤ï¼š500ï¼‰
auto_cleanup_page_cache(
    keep_days=0,
    max_cache_entries=500  # æ”¹ä¸ºå…¶ä»–æ•°å­—ï¼Œå¦‚ 1000 æˆ– 2000
)
```

---

## ğŸ“Š æ¸…ç†æ•ˆæœ / Cleanup Results

### è‡ªåŠ¨æ¸…ç† vs å®Œæ•´æ¸…ç†

| ç‰¹æ€§ | è‡ªåŠ¨æ¸…ç† | å®Œæ•´æ¸…ç† (`scripts/cleanup_database.py`) |
|------|---------|----------------------------------------|
| åˆ é™¤ page_cache | âœ… æ˜¯ | âœ… æ˜¯ |
| åˆ é™¤ extracted_profiles | âŒ å¦ | âœ… æ˜¯ |
| æ¸…ç©º evidence_snippets | âŒ å¦ | âœ… æ˜¯ |
| è¿è¡Œ VACUUM | âŒ å¦ | âœ… æ˜¯ |
| æ‰§è¡Œé€Ÿåº¦ | âš¡ å¿«ï¼ˆ< 1 ç§’ï¼‰ | ğŸŒ æ…¢ï¼ˆå‡ åˆ†é’Ÿï¼‰ |
| è§¦å‘æ–¹å¼ | è‡ªåŠ¨ï¼ˆæ‰¹é‡æ›´æ–°æ—¶ï¼‰ | æ‰‹åŠ¨è¿è¡Œè„šæœ¬ |

### ä¸ºä»€ä¹ˆè‡ªåŠ¨æ¸…ç†ä¸è¿è¡Œ VACUUMï¼Ÿ

- **VACUUM å¾ˆæ…¢**ï¼šå¯¹äºå¤§å‹æ•°æ®åº“ï¼ˆ1GB+ï¼‰ï¼ŒVACUUM å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ
- **ä¸é€‚åˆè‡ªåŠ¨è¿è¡Œ**ï¼šä¼šé˜»å¡æ•°æ®åº“æ“ä½œï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
- **å®šæœŸæ‰‹åŠ¨è¿è¡Œ**ï¼šå»ºè®®å®šæœŸï¼ˆæ¯å‘¨æˆ–æ¯æœˆï¼‰æ‰‹åŠ¨è¿è¡Œ `scripts/cleanup_database.py` è¿›è¡Œå®Œæ•´æ¸…ç†

---

## ğŸ”„ å·¥ä½œæµç¨‹ / Workflow

### æ­£å¸¸ä½¿ç”¨æµç¨‹

```
ç”¨æˆ·æœç´¢
  â†“
å‘ç°æ–°çš„ supervisor profiles
  â†“
æ‰¹é‡ä¿å­˜åˆ°æ•°æ®åº“ (upsert_many)
  â†“
è‡ªåŠ¨æ¸…ç† page_cacheï¼ˆå¦‚æœ >= 10 ä¸ª profilesï¼‰
  â†“
æ•°æ®åº“ä¿æŒè½»é‡çº§
```

### å®šæœŸç»´æŠ¤æµç¨‹

```
æ¯å‘¨/æ¯æœˆ
  â†“
æ‰‹åŠ¨è¿è¡Œ scripts/cleanup_database.py
  â†“
å®Œæ•´æ¸…ç† + VACUUM
  â†“
æ•°æ®åº“ä¼˜åŒ–åˆ°æœ€å°å¤§å°
```

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹ / Usage Examples

### è‡ªåŠ¨æ¸…ç†ï¼ˆæ— éœ€æ“ä½œï¼‰

è‡ªåŠ¨æ¸…ç†ä¼šåœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨è§¦å‘ï¼š

1. **Pipeline æœç´¢åä¿å­˜ç»“æœ**ï¼š
   ```python
   # app/pipeline.py
   save_to_local_db(found_profiles)  # å¦‚æœ >= 10 ä¸ªï¼Œè‡ªåŠ¨æ¸…ç†
   ```

2. **æ‰¹é‡å¯¼å…¥æ•°æ®**ï¼š
   ```python
   # scripts/import_excel_to_db.py
   upsert_many(profiles)  # å¦‚æœ >= 10 ä¸ªï¼Œè‡ªåŠ¨æ¸…ç†
   ```

### æ‰‹åŠ¨å®Œæ•´æ¸…ç†

å¦‚æœéœ€è¦å®Œæ•´æ¸…ç†ï¼ˆåŒ…æ‹¬ VACUUMï¼‰ï¼š

```bash
cd /Users/chrissychen/Documents/PhD_Final_Year/SuperFinder
source .venv/bin/activate
python scripts/cleanup_database.py
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹ / Notes

1. **æ¸…ç†ä¸ä¼šå½±å“æ ¸å¿ƒæ•°æ®**ï¼š
   - âœ… Supervisor profiles ä¿¡æ¯å®Œå…¨ä¿ç•™
   - âœ… åªæœ‰ `page_cache` è¢«åˆ é™¤ï¼ˆå¯é‡æ–°ç”Ÿæˆï¼‰

2. **æ¸…ç†å¤±è´¥ä¸ä¼šä¸­æ–­ä¸»æµç¨‹**ï¼š
   - æ¸…ç†å‡½æ•°ä½¿ç”¨ `try-except` åŒ…è£…
   - å³ä½¿æ¸…ç†å¤±è´¥ï¼Œæ•°æ®åº“æ›´æ–°ä»ä¼šæˆåŠŸ

3. **å°æ‰¹é‡æ›´æ–°ä¸è§¦å‘æ¸…ç†**ï¼š
   - åªæœ‰æ‰¹é‡æ›´æ–° >= 10 ä¸ª profiles æ—¶æ‰æ¸…ç†
   - é¿å…å°æ›´æ–°çš„æ€§èƒ½å¼€é”€

4. **å®šæœŸè¿è¡Œå®Œæ•´æ¸…ç†**ï¼š
   - è‡ªåŠ¨æ¸…ç†æ˜¯è½»é‡çº§çš„ï¼Œä¸è¿è¡Œ VACUUM
   - å»ºè®®å®šæœŸæ‰‹åŠ¨è¿è¡Œå®Œæ•´æ¸…ç†è„šæœ¬

---

## ğŸ” ç›‘æ§æ¸…ç†æ•ˆæœ / Monitoring

### æ£€æŸ¥æ•°æ®åº“å¤§å°

```bash
# æŸ¥çœ‹æ•°æ®åº“æ–‡ä»¶å¤§å°
ls -lh cache.sqlite

# æŸ¥çœ‹ page_cache æ¡ç›®æ•°
sqlite3 cache.sqlite "SELECT COUNT(*) FROM page_cache;"
```

### æŸ¥çœ‹æ¸…ç†ç»Ÿè®¡

æ¸…ç†å‡½æ•°è¿”å›ç»Ÿè®¡ä¿¡æ¯ï¼ˆå½“å‰æœªè®°å½•ï¼Œä½†å¯ä»¥åœ¨ä»£ç ä¸­æ·»åŠ æ—¥å¿—ï¼‰ï¼š

```python
stats = auto_cleanup_page_cache()
# stats = {
#     'deleted': 100,        # åˆ é™¤çš„æ¡ç›®æ•°
#     'before_count': 1000,   # æ¸…ç†å‰çš„æ¡ç›®æ•°
#     'after_count': 0       # æ¸…ç†åçš„æ¡ç›®æ•°
# }
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶ / Related Files

- `app/modules/db_cleanup.py` - è‡ªåŠ¨æ¸…ç†å‡½æ•°
- `app/modules/local_repo.py` - æ•°æ®åº“æ›´æ–°å‡½æ•°ï¼ˆåŒ…å«è‡ªåŠ¨æ¸…ç†è°ƒç”¨ï¼‰
- `scripts/cleanup_database.py` - å®Œæ•´æ¸…ç†è„šæœ¬ï¼ˆæ‰‹åŠ¨è¿è¡Œï¼‰
- `scripts/analyze_database_size.py` - æ•°æ®åº“å¤§å°åˆ†æå·¥å…·

---

**æœ€åæ›´æ–° / Last Updated:** 2024

