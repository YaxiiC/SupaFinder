# 内测用户功能说明

## 📋 概述

内测用户功能允许你为指定的邮箱用户提供免费搜索次数（默认10次），用完后他们需要正常订阅。

## 🔧 配置方式

### 在 Streamlit Secrets 中配置

1. 登录 https://share.streamlit.io/
2. 进入你的应用 → **Settings** → **Secrets**
3. 添加以下配置：

```toml
# 内测用户配置
# 格式: "邮箱1:免费次数,邮箱2:免费次数"
# 例如: "user1@example.com:10,user2@example.com:10"
BETA_USERS = "beta1@test.com:10,beta2@test.com:10,beta3@test.com:10"
```

### 配置说明

- **格式**: `邮箱:免费次数,邮箱:免费次数`（逗号分隔）
- **免费次数**: 每个内测用户获得的免费搜索次数（例如：10）
- **不过期**: 免费次数不会过期，用完为止
- **可以订阅**: 内测用户可以正常订阅，订阅后使用订阅次数

## 🎯 功能特性

### 优先级顺序

1. **开发者模式**（最高优先级）
   - 无限制访问
   - 不扣减任何次数

2. **内测用户免费次数**
   - 如果内测用户有免费次数剩余，优先使用免费次数
   - 免费次数用完后，可以使用订阅次数

3. **正常订阅**
   - Individual Plan: 3次/月
   - Enterprise Plan: 12次/月

### 使用流程

1. **内测用户登录**
   - 系统自动识别为内测用户
   - 初始化免费搜索次数（如果还没有）

2. **搜索时**
   - 优先扣减内测用户的免费次数
   - 如果免费次数用完了，检查是否有订阅
   - 如果有订阅，使用订阅次数
   - 如果没有订阅，提示需要订阅

3. **订阅后**
   - 内测用户可以正常订阅
   - 订阅后，优先使用订阅次数（如果免费次数已用完）
   - 如果免费次数还有剩余，继续使用免费次数

## 📊 UI 显示

内测用户在侧边栏会看到：

- **有免费次数时**: `🧪 Beta User - X free searches remaining`
- **免费次数用完后**: `🧪 Beta User - Free searches used up`
- **如果已订阅**: 同时显示订阅信息

## 🔍 示例配置

```toml
# 单个内测用户
BETA_USERS = "beta@example.com:10"

# 多个内测用户（每个10次）
BETA_USERS = "beta1@example.com:10,beta2@example.com:10,beta3@example.com:10"

# 不同内测用户不同次数（虽然默认都是10次，但可以自定义）
BETA_USERS = "beta1@example.com:10,beta2@example.com:15,beta3@example.com:10"
```

## ⚠️ 注意事项

1. **邮箱匹配**: 邮箱地址大小写不敏感，会自动转换为小写
2. **初始化**: 内测用户首次登录时自动初始化免费次数
3. **数据库字段**: 系统会在 `users` 表中添加 `beta_free_searches_remaining` 字段
4. **与订阅的关系**: 内测用户可以同时拥有免费次数和订阅，优先使用免费次数
5. **开发者模式**: 如果用户既是开发者又是内测用户，开发者模式优先

## 🛠️ 管理内测用户

### 查看内测用户状态

使用脚本查看内测用户状态：

```bash
python3 scripts/update_subscription.py user@example.com
```

### 更新内测用户免费次数

如果需要手动更新内测用户的免费次数，可以直接在数据库中更新 `beta_free_searches_remaining` 字段。

## 📝 与开发者模式的区别

| 特性 | 开发者模式 | 内测用户 |
|------|-----------|---------|
| 访问限制 | 无限制 | 有限次数（默认10次） |
| 是否扣减 | 不扣减 | 扣减免费次数 |
| 配置方式 | `DEVELOPER_EMAILS` | `BETA_USERS` |
| 可以订阅 | 可以（但不需要） | 可以（推荐） |
| 用途 | 开发/测试 | 内测/试用 |

